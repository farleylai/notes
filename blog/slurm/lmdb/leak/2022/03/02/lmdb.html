<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>SLURM Out of Memory with LMDB | A Fuzzy Philosopher</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="SLURM Out of Memory with LMDB" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Implication of memory mapped storage for super large data access." />
<meta property="og:description" content="Implication of memory mapped storage for super large data access." />
<link rel="canonical" href="https://farley.metax.vision/blog/slurm/lmdb/leak/2022/03/02/lmdb.html" />
<meta property="og:url" content="https://farley.metax.vision/blog/slurm/lmdb/leak/2022/03/02/lmdb.html" />
<meta property="og:site_name" content="A Fuzzy Philosopher" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-03-02T00:00:00-06:00" />
<script type="application/ld+json">
{"url":"https://farley.metax.vision/blog/slurm/lmdb/leak/2022/03/02/lmdb.html","@type":"BlogPosting","headline":"SLURM Out of Memory with LMDB","dateModified":"2022-03-02T00:00:00-06:00","datePublished":"2022-03-02T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://farley.metax.vision/blog/slurm/lmdb/leak/2022/03/02/lmdb.html"},"description":"Implication of memory mapped storage for super large data access.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://farley.metax.vision/feed.xml" title="A Fuzzy Philosopher" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">A Fuzzy Philosopher</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/creative/">Creative</a><a class="page-link" href="/portfolio/">Portfolio</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/tags/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">SLURM Out of Memory with LMDB</h1><p class="page-description">Implication of memory mapped storage for super large data access.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-03-02T00:00:00-06:00" itemprop="datePublished">
        Mar 2, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#blog">blog</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#slurm">slurm</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#lmdb">lmdb</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#leak">leak</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          
          
          <div class="px-2">
    <a href="https://colab.research.google.com/github/farleylai/notes/blob/master/_notebooks/2022-03-02-lmdb.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Ffarleylai%2Fnotes%2Fblob%2Fmaster%2F_notebooks%2F2022-03-02-lmdb.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-03-02-lmdb.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>TL; DR</p>
<ul>
<li>SLURM monitors the total resident memory (RSS) consumed by all the task processes (incl. dataloader workers)  </li>
<li><code>pin_memory=True</code> increases RSS significantly and may cause leaks with mmap based LMDB, pushing to the memory limit sooner</li>
<li>PyTorch <code>FastDataLoader</code> or <code>DataLoader</code> created with <code>persistent_workers=True</code> is going to accumulate RSS with workers that never reset MMAP based storage such as <code>LMDB</code> env across epochs</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When it comes to training deep learning models, the I/O storage capacity and transfer bandwidth are ususally the bottleneck.
While HDF5 is efficient to load the entire dataset for training, it is limited to the system memory capacity, typically up to hunderds of GB.
On the other hand, memory mampped (MMAP) storage allows data access beyond system memory constraints.
One popular implementation is LMDB, providing numerous language bindings including Python.
It is tempting to replace HDF5 with LMDB for super large dataset loading and access.
When running locally, potential memory allocation issues may not emerge to the surface as modern computer systems support disk swap space in case the process consumes more than available memory.
However, training deep models could take days or longer and it is not uncommon to set up the training job in a high performance coomputing cluster such as SLURM.
To submit a job to the SLURM cluster, the memory usage must be specified beforehand and at runtime, the memory usage is monitored according to the Resident Set Size (RSS) statistics.
Unfortunately, the same training process on SLRUM is now subject to out of memory error because the swap space may not be available for SLURM tasks and MMAP based LMDB may grow the RSS over time beyond the usage limit. 
The following <code>pytest</code> snippet demonstrates the task RSS is increasing with LMDB access to a huage dataset over epochs:</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="nb">print</span><span class="p">()</span>

<span class="n">KB</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">10</span>
<span class="n">MB</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">10</span> <span class="o">*</span> <span class="n">KB</span>
<span class="n">GB</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">10</span> <span class="o">*</span> <span class="n">MB</span>

<span class="k">def</span> <span class="nf">rss_usage</span><span class="p">(</span><span class="n">breakdown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">psutil</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
    <span class="n">RSS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">RSS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">proc</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">proc</span><span class="o">.</span><span class="n">children</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">RSS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">child</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="p">))</span>
    
    <span class="n">rss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mem</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">mem</span> <span class="ow">in</span> <span class="n">RSS</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rss</span><span class="p">,</span> <span class="n">RSS</span><span class="p">)</span> <span class="k">if</span> <span class="n">breakdown</span> <span class="k">else</span> <span class="n">rss</span>

<span class="k">def</span> <span class="nf">test_rss</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="kn">import</span> <span class="nn">lmdb</span>
    <span class="kn">from</span> <span class="nn">utils.utils</span> <span class="kn">import</span> <span class="n">FastDataLoader</span>
    <span class="kn">from</span> <span class="nn">dataset.lmdb_dataset</span> <span class="kn">import</span> <span class="n">UCF101LMDB_2CLIP</span>
    <span class="kn">from</span> <span class="nn">main_nce</span> <span class="kn">import</span> <span class="n">parse_args</span><span class="p">,</span> <span class="n">get_transform</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">argv</span>
    <span class="n">lmdb_root</span> <span class="o">=</span> <span class="s2">&quot;/mnt/ssd/dataset/ucf101/lmdb&quot;</span>
    <span class="n">lmdb_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lmdb_root</span><span class="si">}</span><span class="s2">/UCF101/ucf101_frame.lmdb&quot;</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">get_transform</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">ucf101</span> <span class="o">=</span> <span class="n">UCF101LMDB_2CLIP</span><span class="p">(</span><span class="n">db_path</span><span class="o">=</span><span class="n">lmdb_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span> <span class="n">num_frames</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_label</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created UCF101 2clip dataset of size </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ucf101</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">FastDataLoader</span><span class="p">(</span><span class="n">ucf101</span><span class="p">,</span> 
                            <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">persistent_workers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                            <span class="n">pin_memory</span><span class="o">=</span><span class="ow">not</span> <span class="kc">True</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">batches</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">rss</span> <span class="o">=</span> <span class="n">rss_usage</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[e</span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">] RSS: </span><span class="si">{</span><span class="n">rss</span> <span class="o">/</span> <span class="n">GB</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">input_seq</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">dataloader</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rss</span><span class="p">,</span> <span class="n">RSS</span> <span class="o">=</span> <span class="n">rss_usage</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">mem</span> <span class="ow">in</span> <span class="n">RSS</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[e</span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">][b</span><span class="si">{</span><span class="n">idx</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">][</span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">] consumes </span><span class="si">{</span><span class="n">mem</span> <span class="o">/</span> <span class="n">GB</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[e</span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">][b</span><span class="si">{</span><span class="n">idx</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">] RSS: </span><span class="si">{</span><span class="n">rss</span> <span class="o">/</span> <span class="n">GB</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> GB&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">batches</span><span class="p">:</span>
                <span class="k">break</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="p">[</span><span class="n">e00</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">2.56</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14023</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.08</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14055</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.49</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14071</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.81</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14087</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.83</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14103</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.84</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b00</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">4.07</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14023</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.08</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14055</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.78</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14071</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.90</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14087</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.64</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14103</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.80</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b04</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">4.20</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14023</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.08</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14055</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.97</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14071</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.00</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14087</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.66</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14103</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.24</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e00</span><span class="p">][</span><span class="n">b08</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">4.95</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">4.97</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14023</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.08</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14055</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.66</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14071</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.92</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14087</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.66</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14103</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.80</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b00</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">4.12</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14023</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.08</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14055</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.80</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14071</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.99</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14087</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.04</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14103</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.03</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b04</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">4.93</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14023</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.08</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14055</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.87</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14071</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.05</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14087</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.19</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14103</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.07</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e01</span><span class="p">][</span><span class="n">b08</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">5.26</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">5.29</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14023</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.08</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14055</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.85</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14071</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.06</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14087</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.09</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b00</span><span class="p">][</span><span class="mi">14103</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.09</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b00</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">5.17</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14023</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.08</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14055</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.92</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14071</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.12</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14087</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.86</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b04</span><span class="p">][</span><span class="mi">14103</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.14</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b04</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">5.12</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14023</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.08</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14055</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.97</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14071</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.19</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14087</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">0.93</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b08</span><span class="p">][</span><span class="mi">14103</span><span class="p">]</span> <span class="n">consumes</span> <span class="mf">1.23</span> <span class="n">GB</span>
<span class="p">[</span><span class="n">e02</span><span class="p">][</span><span class="n">b08</span><span class="p">]</span> <span class="n">RSS</span><span class="p">:</span> <span class="mf">5.39</span> <span class="n">GB</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The root cause is the <code>LMDB</code> Python API to access database records as follows may not release the mapped memory timely on completion to reduce the runtime RSS.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="k">class</span> <span class="nc">UCF101LMDB_2CLIP</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading LMDB from </span><span class="si">%s</span><span class="s1">, split:</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">which_split</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">lmdb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_path</span><span class="p">),</span>
                             <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">readahead</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">meminit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">...</span>
        
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">vpath</span><span class="p">,</span> <span class="n">vlen</span><span class="p">,</span> <span class="n">vlabel</span><span class="p">,</span> <span class="n">vname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">video_subset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="k">with</span> <span class="n">env</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">write</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">txn</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">txn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_video_id</span><span class="p">[</span><span class="n">vname</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Worse, the <a href="https://bit.ly/3vvTXtj">FastLoader</a> never recreates dataset iterator workers that involes the <code>LMDB</code> env and will grow RSS over epochs due to increasing MMAP access.
If using the vanilla <code>DataLoader</code>, make sure to set <code>persistent_workers=False</code> in case of a similar memory leak.
Nonetheless, sufficient memory must be allocated at least for peak usage in one epoch.
This serves as the workaround.</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="farleylai/notes"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/slurm/lmdb/leak/2022/03/02/lmdb.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Blog posts in Jupyter notebooks.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/farleylai" target="_blank" title="farleylai"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/farleylai" target="_blank" title="farleylai"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
